- A student will create a pre-save hook, using bcrypt, to encrypt the userâ€™s password in the user schema.

# Lesson

https://www.youtube.com/watch?v=XMM7AVa3CiA&list=PL1whVIy6oz7NIpURZoywfBtGH0dN_GafK&index=19

---

# **Understanding Mongoose Middleware for Password Hashing**

### **Introduction:**

In this document, we'll break down a Node.js code snippet that uses Mongoose middleware to hash user passwords before saving them to a MongoDB database. This middleware ensures that the password is hashed securely using bcrypt, but only if the password field has been modified.

### **Code Breakdown:**

1. Middleware Registration:
    - **Code Block:**
        
        ```
        userSchema.pre('save', function(next) {
            // Middleware code here
        });
        
        ```
        
    - **Explanation:**
        - This line defines a "pre-save" middleware function for a Mongoose schema. It specifies that the function should be executed before saving a document of this schema.
2. Storing the User Document:
    - **Code Block:**
        
        ```
        const user = this;
        
        ```
        
    - **Explanation:**
        - This line stores the current instance of the user document (the document being saved) in a variable named `user`. `this` refers to the user document that's about to be saved.
3. Checking Password Modification:
    - **Code Block:**
        
        ```
        if (!user.isModified('password')) return next();
        
        ```
        
    - **Explanation:**
        - This conditional statement checks whether the 'password' field in the user document has been modified. If it hasn't been modified, the function exits early by calling the `next()` function. This is useful to avoid rehashing the password unnecessarily when other fields of the user document are updated.
4. Password Hashing with bcrypt:
    - **Code Block:**
        
        ```
        bcrypt.hash(user.password, 10, (err, hash) => {
            // Hashing code here
        });
        
        ```
        
    - **Explanation:**
        - This is an asynchronous call to the `bcrypt.hash` function. It hashes the user's password using bcrypt with a cost factor of 10 (which determines the hashing complexity). The result of the hash operation or any potential error is handled in the callback function.
5. Handling Errors:
    - **Code Block:**
        
        ```
        if (err) return next(err);
        
        ```
        
    - **Explanation:**
        - Inside the callback function for `bcrypt.hash`, it checks if there is an error (`err`) during the hashing process. If an error occurs, it calls `next(err)` to pass the error to the next middleware or the error handler.
6. Updating the Password Property:
    - **Code Block:**
        
        ```
        user.password = hash;
        
        ```
        
    - **Explanation:**
        - If no error occurs, it updates the `user.password` property with the hash generated by bcrypt. This is essentially replacing the user's plaintext password with the securely hashed version.
7. Continuing the Save Operation:
    - **Code Block:**
        
        ```
        next();
        
        ```
        
    - **Explanation:**
        - Finally, if everything goes smoothly, the function calls `next()` to continue the document save process. This is important to ensure that the middleware doesn't block the save operation and allows the document to be saved with the hashed password.

### **Conclusion:**

This middleware is a crucial part of a Node.js application's security, ensuring that user passwords are always stored in a hashed format, enhancing data protection.